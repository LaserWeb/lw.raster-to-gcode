!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("RasterToGcode",[],t):"object"==typeof exports?exports.RasterToGcode=t():e.RasterToGcode=t()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RasterToGcode=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),h=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(n)},u=i(2),c=n(u),f=function(e){function t(e){r(this,t),e=Object.assign({ppi:254,beamSize:.1,beamRange:{min:0,max:1},beamPower:{min:0,max:100},feedRate:1500,feedUnit:"mm/min",offsets:{X:0,Y:0},trimLine:!0,joinPixel:!0,burnWhite:!0,verboseG:!1,diagonal:!1,precision:{X:2,Y:2,S:4},nonBlocking:!0,filters:{smoothing:0,brightness:0,contrast:0,gamma:0,grayscale:"none",shadesOfGray:256},progress:null,progressContext:null,done:null,doneContext:null},e||{});var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.ppm=2540/(100*i.ppi),i.ppm=parseFloat(i.ppm.toFixed(10)),i.scaleRatio=i.ppm/i.beamSize,i.gcode=null,i.currentLine=null,i.lastCommands=null,i.outputSize={width:0,height:0},i.G1=["G",1],i.G0=["G",i.burnWhite?1:0],i.beamOffset=1e3*i.beamSize/2e3,i.realBeamRange={min:i.beamRange.max/100*i.beamPower.min,max:i.beamRange.max/100*i.beamPower.max},"mm/sec"===i.feedUnit&&(i.feedRate*=60),i.progress&&i.on("progress",i.progress,i.progressContext),i.done&&i.on("done",i.done,i.doneContext),i}return s(t,e),l(t,[{key:"_processImage",value:function(){h(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_processImage",this).call(this),this.outputSize={width:this.size.width*(1e3*this.beamSize)/1e3,height:this.size.height*(1e3*this.beamSize)/1e3}}},{key:"run",value:function(e,t){if(this.gcode=[],this.lastCommands={},this.currentLine=null,e&&this.on("progress",e),t&&this.on("done",t),this._addHeader(),this.diagonal?this._scanDiagonally():this._scanHorizontally(),!this.nonBlocking)return this.gcode}},{key:"_addHeader",value:function(){this.gcode.push("; Generated by LaserWeb (lw.raster-to-gcode.js)","; Size       : "+this.outputSize.width+" x "+this.outputSize.height+" mm","; Resolution : "+this.ppm+" PPM - "+this.ppi+" PPI","; Beam size  : "+this.beamSize+" mm","; Beam range : "+this.beamRange.min+" to "+this.beamRange.max,"; Beam power : "+this.beamPower.min+" to "+this.beamPower.max+" %","; Feed rate  : "+this.feedRate+" mm/min");for(var e=["smoothing","trimLine","joinPixel","burnWhite","verboseG","diagonal"],t=e.length-1;t>=0;t--)this[e[t]]||e.splice(t,1);e.length&&this.gcode.push("; Options    : "+e.join(", ")),this.gcode.push("","G0 F"+this.feedRate,"G1 F"+this.feedRate,"")}},{key:"_mapPixelPower",value:function(e){return e*(this.realBeamRange.max-this.realBeamRange.min)/255+this.realBeamRange.min}},{key:"_command",value:function(e,t){if("object"===("undefined"==typeof t?"undefined":a(t))){for(var i=Array.prototype.slice.call(arguments),n=void 0,r=[],o=0,s=i.length;o<s;o++)n=this._command.apply(this,i[o]),n&&r.push(n);return r.length?r.join(" "):null}return t=t.toFixed(this.precision[e]||0),this.verboseG||t!==this.lastCommands[e]?(this.lastCommands[e]=t,e+t):null}},{key:"_getPixelPower",value:function(e,t,i){try{t=this.size.height-t-1;var n=this.getPixel(e,t);return 255-n.gray}catch(e){if(3===arguments.length)return i;throw e}}},{key:"_getPoint",value:function(e){var t=this.currentLine[e];return t?(t.G=t.s?["G",1]:this.G0,t.X=t.x*this.beamSize+this.offsets.X,t.Y=t.y*this.beamSize+this.offsets.Y,t.S=this._mapPixelPower(t.s),this.diagonal?(t.Y+=this.beamSize,t.first||t.lastWhite?(t.X+=this.beamOffset,t.Y-=this.beamOffset):(t.last||t.lastColored)&&(t.X-=this.beamOffset,t.Y+=this.beamOffset)):(t.Y+=this.beamOffset,t.first||t.lastWhite?t.X+=this.beamOffset:(t.last||t.lastColored)&&(t.X-=this.beamOffset)),t):null}},{key:"_trimCurrentLine",value:function(){for(var e=this.currentLine[0];e&&!e.p;)this.currentLine.shift(),e=this.currentLine[0];for(e=this.currentLine[this.currentLine.length-2];e&&!e.p;)this.currentLine.pop(),e=this.currentLine[this.currentLine.length-2];return this.currentLine.length}},{key:"_reduceCurrentLine",value:function(){if(this.currentLine.length<3)return this.currentLine.length;for(var e,t=this.currentLine.splice(1),i=this.currentLine[0].p,n=0,r=t.length-1;n<r;n++)e=t[n],i!==e.p&&this.currentLine.push(e),i=e.p;this.currentLine.push(t[n])}},{key:"_overscanCurrentLine",value:function(e){var t=this.overscan/this.ppm,i=this.currentLine[0],n=this.currentLine[this.currentLine.length-1];i.s&&(i.lastWhite=!0),n.s&&(n.lastColored=!0),e?n.s=0:i.s=0;var r={x:n.x+t,y:n.y,s:0,p:0},o={x:i.x-t,y:i.y,s:0,p:0};this.diagonal&&(o.y+=t,r.y-=t),this.currentLine.unshift(o),this.currentLine.push(r)}},{key:"_processCurrentLine",value:function(e){if(this.trimLine&&!this._trimCurrentLine())return null;this.joinPixel&&this._reduceCurrentLine(),this.overscan&&this._overscanCurrentLine(e),this.currentLine[0].first=!0,this.currentLine[this.currentLine.length-1].last=!0,e&&(this.currentLine=this.currentLine.reverse());var t=void 0,i=0,n=void 0,r=[];for(t=this._getPoint(i),n=this._command(this.G0,["X",t.X],["Y",t.Y],["S",0]),n&&r.push(n);t;)n=this._command(t.G,["X",t.X],["Y",t.Y],["S",t.S]),n&&r.push(n),t=this._getPoint(++i);return r.length?r:null}},{key:"_scanHorizontally",value:function(){var e=this,t=0,i=0,n=void 0,r=void 0,o=void 0,s=void 0,a=this.size.width,l=this.size.height,h=!1,u=!1,c=!1,f=function(){for(e.currentLine=[],o=null,t=0;t<=a;t++)n=r=e._getPixelPower(t,i,r),u=o&&!o.p&&r,c=o&&o.p&&!r,!h&&o&&(n=o.p),o={x:t,y:i,s:n,p:r},u&&(o.lastWhite=!0),c&&(o.lastColored=!0),e.currentLine.push(o)},m=0,d=0,p=function(){s=e._processCurrentLine(h),m=Math.round(i/l*100),m>d&&e._onProgress({gcode:s,percent:m}),d=m,s&&(h=!h,e.gcode.push.apply(e.gcode,s))},g=function t(){f(),p(),i++,i<l?e.nonBlocking?setTimeout(t,0):t():e._onDone({gcode:e.gcode})};g()}},{key:"_scanDiagonally",value:function(){var e=this,t=0,i=0,n=void 0,r=void 0,o=void 0,s=void 0,a=this.size.width,l=this.size.height,h=a+l-1,u=0,c=!1,f=!1,m=!1,d=function(t,i){for(e.currentLine=[],o=null,u++;;){if(i<-1||i==l)break;if(t<0||t>a)break;n=r=e._getPixelPower(t,i,r),f=o&&!o.p&&r,m=o&&o.p&&!r,!c&&o&&(n=o.p),o={x:t,y:i,s:n,p:r},f&&(o.lastWhite=!0),m&&(o.lastColored=!0),e.currentLine.push(o),t++,i--}},p=0,g=0,v=function(){s=e._processCurrentLine(c),p=Math.round(u/h*100),p>g&&e._onProgress({gcode:s,percent:p}),g=p,s&&(c=!c,e.gcode.push.apply(e.gcode,s))},b=function n(){d(t,i),v(),t?t++:i++,i===l&&(t++,i--),i<l&&t<a?e.nonBlocking?setTimeout(n,0):n():e._onDone({gcode:e.gcode})};b()}},{key:"_onProgress",value:function(e){}},{key:"_onDone",value:function(e){}},{key:"on",value:function(e,t,i){var n=this,r="_on"+e[0].toUpperCase()+e.slice(1);if(!this[r]||"function"!=typeof this[r])throw new Error("Undefined event: "+e);return this[r]=function(e){return t.call(i||n,e)},this}}]),t}(c.default);t.RasterToGcode=f,t.default=f},function(e,t,i){!function(t,i){e.exports=i()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.CanvasGrid=void 0;var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=i(2),a=n(s),l=function(){function e(t){r(this,e),this.cellSize=1024,this.scaleRatio=1,this.filters={},Object.assign(this,t||{}),this.size={width:0,height:0,cols:0,rows:0},this.file=null,this.image=null,this.url=null,this.canvas=[],this.pixels=[]}return o(e,[{key:"load",value:function(e){return e instanceof File?this.loadFromFile(e):e instanceof Image?this.loadFromImage(e):"string"==typeof e||e instanceof URL?this.loadFromURL(e.trim()):Promise.reject(new Error("Unsupported input format."))}},{key:"_loadImage",value:function(e,t,i){var n=this,r=new Image;r.onload=function(e){n.loadFromImage(r).then(function(e){n._processImage(),i(e)}).catch(t)},r.onerror=function(i){t(new Error("Error reading file : "+e))},r.src=e}},{key:"loadFromFile",value:function(e){var t=this;return new Promise(function(i,n){e instanceof File||n(new Error("Input param must be a File object.")),t.file=e,t._loadImage(URL.createObjectURL(e),n,i)})}},{key:"loadFromURL",value:function(e){var t=this;return new Promise(function(i,n){e instanceof URL||"string"==typeof e||n(new Error("Input param must be a URL string or object."));var r=e instanceof URL?e:new URL(e);t.url=r,t._loadImage(r,n,i)})}},{key:"loadFromImage",value:function(e){var t=this;return new Promise(function(i,n){e instanceof Image||n(new Error("Input param must be a Image object.")),t.image=e,i(t)})}},{key:"_processImage",value:function(){this.canvas=[],this.pixels=[];var e=Math.round(this.image.width*this.scaleRatio),t=Math.round(this.image.height*this.scaleRatio),i=Math.ceil(e/this.cellSize),n=Math.ceil(t/this.cellSize);this.size={width:e,height:t,cols:i,rows:n};var r=null,o=null,s=null,l=null,h=null,u=null,c=null,f=null,m=null;for(h=0;h<this.size.rows;h++){for(r=[],l=0;l<this.size.cols;l++)o=document.createElement("canvas"),0===l||l<this.size.cols-1?o.width=this.size.width<this.cellSize?this.size.width:this.cellSize:o.width=this.size.width%this.cellSize,0===h||h<this.size.rows-1?o.height=this.size.height<this.cellSize?this.size.height:this.cellSize:o.height=this.size.height%this.cellSize,s=o.getContext("2d"),s.fillStyle="white",s.fillRect(0,0,o.width,o.height),f=o.width/this.scaleRatio,m=o.height/this.scaleRatio,u=l*this.cellSize/this.scaleRatio,c=h*this.cellSize/this.scaleRatio,s.drawImage(this.image,u,c,f,m,0,0,o.width,o.height),(0,a.default)(o,this.filters),r.push(o);this.canvas.push(r)}}},{key:"getPixel",value:function(e,t){if(e=parseInt(e),t=parseInt(t),isNaN(e)||isNaN(t))throw new Error("[x, y] params must be Integer.");if(e<0||e>=this.size.width)throw new Error("Out of range: x = "+e+", max: "+this.size.width);if(t<0||t>=this.size.height)throw new Error("Out of range: y = "+t+", max: "+this.size.height);var i=parseInt(e/this.cellSize),n=parseInt(t/this.cellSize);i&&(e-=this.cellSize*i),n&&(t-=this.cellSize*n);var r=this.canvas[n][i],o=r.getContext("2d"),s=o.getImageData(e,t,1,1).data;return{color:{r:s[0],g:s[1],b:s[2],a:s[3]},gray:(s[0]+s[1]+s[2])/3,grid:{col:i,row:n},coords:{x:e,y:t}}}}]),e}();t.CanvasGrid=l,t.default=l},function(e,t,i){!function(t,i){e.exports=i()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t){"use strict";function i(e){return e<0?0:e>255?255:e}function n(e,t,n){void 0!==n&&(e[t]=i(e[t]+n),e[t+1]=i(e[t+1]+n),e[t+2]=i(e[t+2]+n))}function r(e,t,n){void 0!==n&&(e[t]=i(n*(e[t]-128)+128),e[t+1]=i(n*(e[t+1]-128)+128),e[t+2]=i(n*(e[t+2]-128)+128))}function o(e,t,n){void 0!==n&&(e[t]=i(Math.exp(Math.log(255*(e[t]/255))*n)),e[t+1]=i(Math.exp(Math.log(255*(e[t+1]/255))*n)),e[t+2]=i(Math.exp(Math.log(255*(e[t+2]/255))*n)))}function s(e,t,n,r){if(l.indexOf(n)===-1)throw new Error("Unsupported grayscale algorithm: "+n);if("none"===n)return null;var o=void 0,s=e[t],a=e[t+1],h=e[t+2];switch(n){case"average":o=(s+a+h)/3;break;case"luma":o=.3*s+.59*a+.11*h;break;case"luma-601":o=.299*s+.587*a+.114*h;break;case"luma-709":o=.2126*s+.7152*a+.0722*h;break;case"luma-240":o=.212*s+.701*a+.087*h;break;case"desaturation":o=(Math.max(s,a,h)+Math.min(s,a,h))/2;break;case"decomposition-min":o=Math.min(s,a,h);break;case"decomposition-max":o=Math.max(s,a,h);break;case"red-chanel":o=s;break;case"green-chanel":o=a;break;case"blue-chanel":o=h}void 0!==r&&(o=parseInt(o/r)*r),o=parseInt(o),e[t]=i(o),e[t+1]=i(o),e[t+2]=i(o)}function a(e,t){t=Object.assign({},{smoothing:!1,brightness:0,contrast:0,gamma:0,grayscale:"none",shadesOfGray:256},t||{});var i=e.getContext("2d");void 0!==i.imageSmoothingEnabled?i.imageSmoothingEnabled=t.smoothing:(i.mozImageSmoothingEnabled=t.smoothing,i.webkitImageSmoothingEnabled=t.smoothing,i.msImageSmoothingEnabled=t.smoothing,i.oImageSmoothingEnabled=t.smoothing);var a=i.getImageData(0,0,e.width,e.height),l=a.data,h=void 0,u=void 0,c=void 0,f=void 0;0!==t.contrast&&(h=259*(t.contrast+255)/(255*(259-t.contrast))),0!==t.brightness&&(u=t.brightness),0!==t.gamma&&(c=1/t.gamma),t.shadesOfGray>1&&t.shadesOfGray<256&&(f=255/(t.shadesOfGray-1));for(var m=0,d=l.length;m<d;m+=4)n(l,m,u),r(l,m,h),o(l,m,c),s(l,m,t.grayscale,f);i.putImageData(a,0,0)}Object.defineProperty(t,"__esModule",{value:!0});var l=["none","average","desaturation","decomposition-min","decomposition-max","luma","luma-601","luma-709","luma-240","red-chanel","green-chanel","blue-chanel"];t.canvasFilters=a,t.default=a}])})}])})}])});
//# sourceMappingURL=lw.raster-to-gcode.js.map