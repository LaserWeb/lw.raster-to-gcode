!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("RasterToGcode",[],t):"object"==typeof exports?exports.RasterToGcode=t():e.RasterToGcode=t()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var o=i[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RasterToGcode=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function e(t,i,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,i);if(void 0===o){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in o)return o.value;var s=o.get;if(void 0!==s)return s.call(n)},u=i(2),c=n(u),f=function(e){function t(e){o(this,t),e=Object.assign({ppi:{x:254,y:254},beamSize:.1,beamRange:{min:0,max:1},beamPower:{min:0,max:100},feedRate:1500,feedUnit:"mm/min",offsets:{X:0,Y:0},trimLine:!0,joinPixel:!0,burnWhite:!0,verboseG:!1,diagonal:!1,overscan:0,precision:{X:2,Y:2,S:4},nonBlocking:!0,filters:{smoothing:0,brightness:0,contrast:0,gamma:0,grayscale:"none",shadesOfGray:256,invertColor:!1},progress:null,progressContext:null,done:null,doneContext:null},e||{});var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.ppi.x||(i.ppi={x:i.ppi,y:i.ppi}),i.ppm={x:parseFloat((2540/(100*i.ppi.x)).toFixed(10)),y:parseFloat((2540/(100*i.ppi.y)).toFixed(10))},i.scaleRatio={x:i.ppm.x/i.beamSize,y:i.ppm.y/i.beamSize},i.gcode=null,i.currentLine=null,i.lastCommands=null,i.outputSize={width:0,height:0},i.G1=["G",1],i.G0=["G",i.burnWhite?1:0],i.beamOffset=1e3*i.beamSize/2e3,i.realBeamRange={min:i.beamRange.max/100*i.beamPower.min,max:i.beamRange.max/100*i.beamPower.max},"mm/sec"===i.feedUnit&&(i.feedRate*=60),i.progress&&i.on("progress",i.progress,i.progressContext),i.done&&i.on("done",i.done,i.doneContext),i}return s(t,e),h(t,[{key:"_processImage",value:function(){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_processImage",this).call(this),this.outputSize={width:this.size.width*(1e3*this.beamSize)/1e3,height:this.size.height*(1e3*this.beamSize)/1e3}}},{key:"run",value:function(e){this.gcode=[],this.lastCommands={},this.currentLine=null,e=e||{},e.progress&&this.on("progress",e.progress,e.progressContext),e.done&&this.on("done",e.done,e.doneContext);var t=this.nonBlocking;if(void 0!==e.nonBlocking&&(t=e.nonBlocking),this._addHeader(),this.diagonal?this._scanDiagonally(t):this._scanHorizontally(t),!t)return this.gcode}},{key:"_addHeader",value:function(){this.gcode.push("; Generated by LaserWeb (lw.raster-to-gcode.js)","; Size       : "+this.outputSize.width+" x "+this.outputSize.height+" mm","; PPI        : x: "+this.ppi.x+" - y: "+this.ppi.y,"; PPM        : x: "+this.ppm.x+" - y: "+this.ppm.y,"; Beam size  : "+this.beamSize+" mm","; Beam range : "+this.beamRange.min+" to "+this.beamRange.max,"; Beam power : "+this.beamPower.min+" to "+this.beamPower.max+" %","; Feed rate  : "+this.feedRate+" mm/min");for(var e=["smoothing","trimLine","joinPixel","burnWhite","verboseG","diagonal"],t=e.length-1;t>=0;t--)this[e[t]]||e.splice(t,1);e.length&&this.gcode.push("; Options    : "+e.join(", ")),this.gcode.push("","G0 F"+this.feedRate,"G1 F"+this.feedRate,"")}},{key:"_mapPixelPower",value:function(e){return e*(this.realBeamRange.max-this.realBeamRange.min)/255+this.realBeamRange.min}},{key:"_command",value:function(e,t){if("object"===("undefined"==typeof t?"undefined":a(t))){for(var i=Array.prototype.slice.call(arguments),n=void 0,o=[],r=0,s=i.length;r<s;r++)n=this._command.apply(this,i[r]),n&&o.push(n);return o.length?o.join(" "):null}return t=t.toFixed(this.precision[e]||0),this.verboseG||t!==this.lastCommands[e]?(this.lastCommands[e]=t,e+t):null}},{key:"_getPixelPower",value:function(e,t,i){try{t=this.size.height-t-1;var n=this.getPixel(e,t);return 255-n.gray}catch(e){if(3===arguments.length)return i;throw e}}},{key:"_getPoint",value:function(e){var t=this.currentLine[e];return t?(t.G=t.s?["G",1]:this.G0,t.X=t.x*this.beamSize+this.offsets.X,t.Y=t.y*this.beamSize+this.offsets.Y,t.S=this._mapPixelPower(t.s),this.diagonal?(t.Y+=this.beamSize,t.first||t.lastWhite?(t.X+=this.beamOffset,t.Y-=this.beamOffset):(t.last||t.lastColored)&&(t.X-=this.beamOffset,t.Y+=this.beamOffset)):(t.Y+=this.beamOffset,t.first||t.lastWhite?t.X+=this.beamOffset:(t.last||t.lastColored)&&(t.X-=this.beamOffset)),t):null}},{key:"_trimCurrentLine",value:function(){for(var e=this.currentLine[0];e&&!e.p;)this.currentLine.shift(),e=this.currentLine[0];for(e=this.currentLine[this.currentLine.length-2];e&&!e.p;)this.currentLine.pop(),e=this.currentLine[this.currentLine.length-2];return this.currentLine.length}},{key:"_reduceCurrentLine",value:function(){if(this.currentLine.length<3)return this.currentLine.length;for(var e,t=this.currentLine.splice(1),i=this.currentLine[0].p,n=0,o=t.length-1;n<o;n++)e=t[n],i!==e.p&&this.currentLine.push(e),i=e.p;this.currentLine.push(t[n])}},{key:"_overscanCurrentLine",value:function(e){var t=this.overscan/this.ppm.x,i=this.currentLine[0],n=this.currentLine[this.currentLine.length-1];i.s&&(i.lastWhite=!0),n.s&&(n.lastColored=!0),e?n.s=0:i.s=0;var o={x:n.x+t,y:n.y,s:0,p:0},r={x:i.x-t,y:i.y,s:0,p:0};this.diagonal&&(r.y+=t,o.y-=t),this.currentLine.unshift(r),this.currentLine.push(o)}},{key:"_processCurrentLine",value:function(e){if(this.trimLine&&!this._trimCurrentLine())return null;this.joinPixel&&this._reduceCurrentLine(),this.overscan&&this._overscanCurrentLine(e),this.currentLine[0].first=!0,this.currentLine[this.currentLine.length-1].last=!0,e&&(this.currentLine=this.currentLine.reverse());var t=void 0,i=0,n=void 0,o=[];for(t=this._getPoint(i),n=this._command(this.G0,["X",t.X],["Y",t.Y],["S",0]),n&&o.push(n);t;)n=this._command(t.G,["X",t.X],["Y",t.Y],["S",t.S]),n&&o.push(n),t=this._getPoint(++i);return o.length?o:null}},{key:"_scanHorizontally",value:function(e){var t=this,i=0,n=0,o=void 0,r=void 0,s=void 0,a=void 0,h=this.size.width,l=this.size.height,u=!1,c=!1,f=!1,p=function(){for(t.currentLine=[],s=null,i=0;i<=h;i++)o=r=t._getPixelPower(i,n,r),c=s&&!s.p&&r,f=s&&s.p&&!r,!u&&s&&(o=s.p),s={x:i,y:n,s:o,p:r},c&&(s.lastWhite=!0),f&&(s.lastColored=!0),t.currentLine.push(s)},d=0,m=0,g=function(){a=t._processCurrentLine(u),d=Math.round(n/l*100),d>m&&t._onProgress({gcode:a,percent:d}),m=d,a&&(u=!u,t.gcode.push.apply(t.gcode,a))},v=function i(){p(),g(),n++,n<l?e?setTimeout(i,0):i():t._onDone({gcode:t.gcode})};v()}},{key:"_scanDiagonally",value:function(e){var t=this,i=0,n=0,o=void 0,r=void 0,s=void 0,a=void 0,h=this.size.width,l=this.size.height,u=h+l-1,c=0,f=!1,p=!1,d=!1,m=function(e,i){for(t.currentLine=[],s=null,c++;;){if(i<-1||i==l)break;if(e<0||e>h)break;o=r=t._getPixelPower(e,i,r),p=s&&!s.p&&r,d=s&&s.p&&!r,!f&&s&&(o=s.p),s={x:e,y:i,s:o,p:r},p&&(s.lastWhite=!0),d&&(s.lastColored=!0),t.currentLine.push(s),e++,i--}},g=0,v=0,y=function(){a=t._processCurrentLine(f),g=Math.round(c/u*100),g>v&&t._onProgress({gcode:a,percent:g}),v=g,a&&(f=!f,t.gcode.push.apply(t.gcode,a))},b=function o(){m(i,n),y(),i?i++:n++,n===l&&(i++,n--),n<l&&i<h?e?setTimeout(o,0):o():t._onDone({gcode:t.gcode})};b()}},{key:"_onProgress",value:function(e){}},{key:"_onDone",value:function(e){}},{key:"on",value:function(e,t,i){var n=this,o="_on"+e[0].toUpperCase()+e.slice(1);if(!this[o]||"function"!=typeof this[o])throw new Error("Undefined event: "+e);return this[o]=function(e){return t.call(i||n,e)},this}},{key:"getHeightMap",value:function(e){var t=this,i=[],n=0,o=0,r=this.size.width,s=this.size.height,a=0,h=0;e=e||{};var l=e.progress||function(){},u=e.done||function(){},c=this.nonBlocking;void 0!==e.nonBlocking&&(c=e.nonBlocking);var f=function(){var u=[];for(n=0;n<r;n++)u.push(t._mapPixelPower(t._getPixelPower(n,o)));a=Math.round(o/s*100),a>h&&l.call(e.progressContext||t,{pixels:u,percent:a}),h=a,i.push(u)},p=function n(){f(),o++,o<s?c?setTimeout(n,0):n():u.call(e.doneContext||t,{heightMap:i})};if(p(),!c)return i}}]),t}(c.default);t.RasterToGcode=f,t.default=f},function(e,t,i){!function(t,i){e.exports=i()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var o=i[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.CanvasGrid=void 0;var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=i(2),a=n(s),h=function(){function e(t){o(this,e),this.cellSize=1024,this.scaleRatio={x:1,y:1},this.filters={},Object.assign(this,t||{}),this.scaleRatio.x||(this.scaleRatio={x:this.scaleRatio,y:this.scaleRatio}),this.size={width:0,height:0,cols:0,rows:0},this.file=null,this.image=null,this.url=null,this.canvas=[],this.pixels=[]}return r(e,[{key:"load",value:function(e){return e instanceof File?this.loadFromFile(e):e instanceof Image?this.loadFromImage(e):"string"==typeof e||e instanceof URL?this.loadFromURL(e.trim()):Promise.reject(new Error("Unsupported input format."))}},{key:"_loadImage",value:function(e,t,i){var n=this,o=new Image;o.onload=function(e){n.loadFromImage(o).then(i).catch(t)},o.onerror=function(i){t(new Error("An error occurred while loading the image : "+e))},o.src=e}},{key:"loadFromFile",value:function(e){var t=this;return new Promise(function(i,n){e instanceof File||n(new Error("Input param must be a File object.")),t.file=e,t._loadImage(URL.createObjectURL(e),n,i)})}},{key:"loadFromURL",value:function(e){var t=this;return new Promise(function(i,n){e instanceof URL||"string"==typeof e||n(new Error("Input param must be a URL string or object."));var o=e instanceof URL?e:new URL(e);t.url=o,t._loadImage(o,n,i)})}},{key:"loadFromImage",value:function(e){var t=this;return new Promise(function(i,n){e instanceof Image||n(new Error("Input param must be a Image object.")),t.image=e,t._processImage(),i(t)})}},{key:"_processImage",value:function(){this.canvas=[],this.pixels=[];var e=Math.round(this.image.width*this.scaleRatio.x),t=Math.round(this.image.height*this.scaleRatio.y),i=Math.ceil(e/this.cellSize),n=Math.ceil(t/this.cellSize);this.size={width:e,height:t,cols:i,rows:n};var o=null,r=null,s=null,h=null,l=null,u=null,c=null,f=null,p=null;for(l=0;l<this.size.rows;l++){for(o=[],h=0;h<this.size.cols;h++)r=document.createElement("canvas"),0===h||h<this.size.cols-1?r.width=this.size.width<this.cellSize?this.size.width:this.cellSize:r.width=this.size.width%this.cellSize,0===l||l<this.size.rows-1?r.height=this.size.height<this.cellSize?this.size.height:this.cellSize:r.height=this.size.height%this.cellSize,s=r.getContext("2d"),s.fillStyle="white",s.fillRect(0,0,r.width,r.height),f=r.width/this.scaleRatio.x,p=r.height/this.scaleRatio.y,u=h*this.cellSize/this.scaleRatio.x,c=l*this.cellSize/this.scaleRatio.y,s.drawImage(this.image,u,c,f,p,0,0,r.width,r.height),(0,a.default)(r,this.filters),o.push(r);this.canvas.push(o)}}},{key:"getPixel",value:function(e,t){if(e=parseInt(e),t=parseInt(t),isNaN(e)||isNaN(t))throw new Error("[x, y] params must be Integer.");if(e<0||e>=this.size.width)throw new Error("Out of range: x = "+e+", max: "+this.size.width);if(t<0||t>=this.size.height)throw new Error("Out of range: y = "+t+", max: "+this.size.height);var i=parseInt(e/this.cellSize),n=parseInt(t/this.cellSize);i&&(e-=this.cellSize*i),n&&(t-=this.cellSize*n);var o=this.canvas[n][i],r=o.getContext("2d"),s=r.getImageData(e,t,1,1).data;return{color:{r:s[0],g:s[1],b:s[2],a:s[3]},gray:(s[0]+s[1]+s[2])/3,grid:{col:i,row:n},coords:{x:e,y:t}}}}]),e}();t.CanvasGrid=h,t.default=h},function(e,t,i){!function(t,i){e.exports=i()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var o=i[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t){"use strict";function i(e){return e<0?0:e>255?255:e}function n(e,t,n){n&&(e[t]=i(255-e[t]),e[t+1]=i(255-e[t+1]),e[t+2]=i(255-e[t+2]))}function o(e,t,n){void 0!==n&&(e[t]=i(e[t]+n),e[t+1]=i(e[t+1]+n),e[t+2]=i(e[t+2]+n))}function r(e,t,n){void 0!==n&&(e[t]=i(n*(e[t]-128)+128),e[t+1]=i(n*(e[t+1]-128)+128),e[t+2]=i(n*(e[t+2]-128)+128))}function s(e,t,n){void 0!==n&&(e[t]=i(Math.exp(Math.log(255*(e[t]/255))*n)),e[t+1]=i(Math.exp(Math.log(255*(e[t+1]/255))*n)),e[t+2]=i(Math.exp(Math.log(255*(e[t+2]/255))*n)))}function a(e,t,n,o){if(l.indexOf(n)===-1)throw new Error("Unsupported grayscale algorithm: "+n);if("none"===n)return null;var r=void 0,s=e[t],a=e[t+1],h=e[t+2];switch(n){case"average":r=(s+a+h)/3;break;case"luma":r=.3*s+.59*a+.11*h;break;case"luma-601":r=.299*s+.587*a+.114*h;break;case"luma-709":r=.2126*s+.7152*a+.0722*h;break;case"luma-240":r=.212*s+.701*a+.087*h;break;case"desaturation":r=(Math.max(s,a,h)+Math.min(s,a,h))/2;break;case"decomposition-min":r=Math.min(s,a,h);break;case"decomposition-max":r=Math.max(s,a,h);break;case"red-chanel":r=s;break;case"green-chanel":r=a;break;case"blue-chanel":r=h}void 0!==o&&(r=parseInt(r/o)*o),r=parseInt(r),e[t]=i(r),e[t+1]=i(r),e[t+2]=i(r)}function h(e,t){t=Object.assign({},{smoothing:!1,brightness:0,contrast:0,gamma:0,grayscale:"none",shadesOfGray:256,invertColor:!1},t||{});var i=e.getContext("2d");void 0!==i.imageSmoothingEnabled?i.imageSmoothingEnabled=t.smoothing:(i.mozImageSmoothingEnabled=t.smoothing,i.webkitImageSmoothingEnabled=t.smoothing,i.msImageSmoothingEnabled=t.smoothing,i.oImageSmoothingEnabled=t.smoothing);var h=i.getImageData(0,0,e.width,e.height),l=h.data,u=void 0,c=void 0,f=void 0,p=void 0;0!==t.contrast&&(u=259*(t.contrast+255)/(255*(259-t.contrast))),0!==t.brightness&&(c=t.brightness),0!==t.gamma&&(f=1/t.gamma),t.shadesOfGray>1&&t.shadesOfGray<256&&(p=255/(t.shadesOfGray-1));for(var d=0,m=l.length;d<m;d+=4)n(l,d,t.invertColor),o(l,d,c),r(l,d,u),s(l,d,f),a(l,d,t.grayscale,p);i.putImageData(h,0,0)}Object.defineProperty(t,"__esModule",{value:!0});var l=["none","average","desaturation","decomposition-min","decomposition-max","luma","luma-601","luma-709","luma-240","red-chanel","green-chanel","blue-chanel"];t.canvasFilters=h,t.default=h}])})}])})}])});
//# sourceMappingURL=lw.raster-to-gcode.min.js.map